---
layout: post
title: node 基础学习(三)
categories: 原创
tags: node
---

什么风把你吹来的，让我变成一个焕然一新的人

<!--more-->

今天发现要做后端，要了解通信，肯定也要懂`TPC`啊。瞬间觉得当年没有认真上课真的是悔恨啊。简单了解了一下`TCP`

### `TCP/IP`

所谓的协议就是双方进行数据传输的一种格式。`TCP/IP`协议栈主要分为四层：应用层、传输层、网络层、数据链路层。

![TCP/IP协议栈分层](http://karynsong.github.io/static/img/tcp.png "TCP/IP协议栈分层")

那具体下来什么是`TCP/IP`呢？

> * TCP/IP 是供已连接因特网的计算机进行通信的通信协议。
> * TCP/IP 指传输控制协议/网际协议 (Transmission Control Protocol / Internet Protocol)。
> * TCP/IP 定义了电子设备（比如计算机）如何连入因特网，以及数据如何在它们之间传输的标准。

`Node HTTP`服务器构建字`Node TCP`，`http.server`继承字`net.server`。

### `TCP`特性

> * 面向字节：TCP 对字符及字符编码完全不知。不同编码会导致传输的字节数不同。
> * 可靠性：TCP 是基于底层不可靠的服务。TCP 使用确认和超时来实现可靠性要求的。
> * 流控制：TCP 用流控制来确保两点之间传输数据的平衡。
> * 拥堵控制：TCP 有一种内置的机制能够控制数据包的延迟率及丢包率不会太高。

### 聊天室

下面是基于`TCP`实现了一个简单的网络聊天室，只要在一个网段里，就可以相互发送一些消息。创建文件：`chat.js`。

    // 引入net模块
    var net = require('net');

    var count = 0,      // 用于统计加入聊天室的人数
        users = {};     // 统计聊天用户

    // 发送消息的方法
    function pushMessage(userName, message){
        for(var x in users){
            if(x !== userName){
                users[x].write(message);
            }
        }
    }

    // 创建一个net连接
    var server = net.createServer(function(connet){
        // 当前用户名
        var userName;
        // 设置字符类型
        connet.setEncoding('utf8');
        // 统计人数
        ++count;
        // 一些话
        connet.write('\033[91m 欢迎来到karyn聊天室 \033[39m \n');
        connet.write('\033[91m 目前聊天室中有' + count + '人 \033[39m \n');
        connet.write('\033[91m 请输入你的名字： \033[39m');
        // 监听输入的数据
        connet.on('data', function(data){
            // 去掉输入时的回车，这个是mac的回车
            data = data.replace('\r\n', '');
            // 默认第一次输入的是用户名
            if(!userName){
                // 用户名验证重复
                if(users[data]) {
                    connet.write('\033[91m 名字和聊天室中有重复，请重新命名 \033[39m \n');
                    return;
                }else{
                    // 给其他人发送消息
                    userName = data;
                    users[data] = connet;
                    pushMessage(userName, '\033[91m 欢迎' + userName + '加入聊天室 \033[39m \n')
                }
            }else{
                // 给其他人发送消息
                pushMessage(userName, '\033[91m ' + userName + ' ： \033[39m' + data + '\n');
            }
        });
        // 关闭聊天室
        connet.on('close', function(data){
            --count;
            delete users[userName]
        });
    });
    // 监听 2000 端口
    server.listen(2000, function(){
        console.log('\033[91m 正在监听2000端口 \033[39m');
    });

启动服务，启动服务之后相当于建立了聊天室服务器，服务启动了。

    node chat.js

加入聊天室。本质是连接服务器。根据代码提示就可以加入聊天了。

    telnet 127.0.0.1 2000

### `HTTP`

超文本传输协议。现在互联网数据交互请求绝大部分都是建立在这个的基础上。目前自己仅仅是非常肤浅的了解，`http`在后续的学习中，也非常希望抽出一块儿完整的时间系统的学习这块的知识。这里只是对`node`提供的`API`进行一些解释

    var http = require('http');
    http.createServer(function(req, res){
        res.writeHead(200,{
            'Content-Type': 'text/html'
        });
        res.write('hello');
        setTimeout(function(){
            res.end('world');
        },2000)
    }).listen(2000);

上面这个就是一个最简单的请求回溯，监听的端口是`2000`，启动服务之后，访问`127.0.0.1:2000`地址就可以触发上面这个方法。`req`是请求的对象，`res`是回溯的对象。`res.end`方法代表完成并回溯数据。上面也有一些特点。首先可以看到，我们在`header`中标明返回类型。当然还可以声明其他`header`。在`res.write`之后接上`res.end`，直至`res.end`之后才会发出去回溯。
